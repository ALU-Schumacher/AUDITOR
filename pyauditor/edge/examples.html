

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; pyauditor  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Documentation" href="api.html" />
    <link rel="prev" title="Welcome to pyauditor’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pyauditor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-record">Creating a Record</a></li>
<li class="toctree-l2"><a class="reference internal" href="#connecting-to-auditor">Connecting to Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pushing-records-to-auditor">Pushing records to Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pushing-a-list-of-records-to-auditor">Pushing a list of records to Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-records-in-auditor">Updating records in Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#receiving-all-records-from-auditor-deprecated">Receiving all records from Auditor (Deprecated)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#receiving-all-records-started-stopped-since-a-given-timestamp-deprecated">Receiving all records started/stopped since a given timestamp (Deprecated)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-query">Advanced Query</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#template-query">Template Query</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operators">Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#meta-operators">Meta Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sortby-operators">SortBy Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sortby-column-names">SortBy Column names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-fields-and-operators">Filter Fields and Operators</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#querybuilder">QueryBuilder</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examples-1">Examples 1:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-2">Example 2:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-3">Example 3:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-4">Example 4:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-5">Example 5:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Example 5:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#checking-the-health-of-auditor">Checking the health of Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-utc-timestamps">Creating UTC timestamps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#timestamp-already-in-utc">Timestamp already in UTC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#timestamp-in-local-time">Timestamp in local time</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pyauditor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/examples.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial">
<span id="ref-examples"></span><h1>Tutorial<a class="headerlink" href="#tutorial" title="Link to this heading"></a></h1>
<p>This section walks you through several basic usecases of <cite>pyauditor</cite>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Records and interacting with Auditor requires timestamps, for instance to indicate when a resource became available or unavailable, or when requesting a list of records from Auditor.
For simplicity, the entire Auditor ecosystem uses UTC.
Pythons handling of timezones is unfortunately suboptimal, therefore ensuring that the times are correct is your responsibility.
At the end of this section there is a short tutorial on how to get correct timestamps.</p>
</div>
<p>Auditor is designed around so-called records, which are the unit of accountable resources.
Records are created and pushed to Auditor, which stores them in a database.
These records can then be requested again from Auditor to take an action based on the information stored in the records.</p>
<p>A record consists of a unique identifier and meta information which provides some context (associated site, group, user).
It also contains an arbitrary number of <cite>components</cite> that are to be accounted for (CPU, RAM, Disk, …) and the amount of each of these components.
The components can optionally be enhanced with <cite>scores</cite>, which are floating point values which put components of the same kind, but different performance in relation to each other.
For instance, in case of CPUs these could be HEPSPEC06 benchmark values.</p>
<p>pyauditor is an async library and as such requires an event loop.</p>
<section id="creating-a-record">
<h2>Creating a Record<a class="headerlink" href="#creating-a-record" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Record</span><span class="p">,</span> <span class="n">Meta</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">score</span>

<span class="c1"># Define meta information</span>
<span class="n">record_id</span> <span class="o">=</span> <span class="s2">&quot;record-1&quot;</span> <span class="c1"># Must be unique for all records in Auditor!</span>

<span class="c1"># Time when the resource became available</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">79043</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="c1"># in UTC</span>

<span class="c1"># Create record</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">record_id</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

<span class="c1"># Create a component (10 CPU cores)</span>
<span class="n">component</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Create a score</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="s2">&quot;HEPSPEC06&quot;</span><span class="p">,</span> <span class="mf">9.2</span><span class="p">)</span>

<span class="c1"># Attach the score to the component</span>
<span class="n">component</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">with_score</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

<span class="c1"># Attach the component to the record</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="c1"># Create meta</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">()</span>

<span class="c1"># Add information to meta</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;site_id&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;site1&quot;</span><span class="p">])</span>

<span class="c1"># Attach meta to record</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

<span class="c1"># Resource stopped being available</span>
<span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">79043</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="c1"># in UTC</span>

<span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_stop_time</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="connecting-to-auditor">
<h2>Connecting to Auditor<a class="headerlink" href="#connecting-to-auditor" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">AuditorClientBuilder</span></code> is used to build an <code class="docutils literal notranslate"><span class="pre">AuditorClient</span></code> object which can be used for interacting with Auditor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuditorClientBuilder</span>

<span class="c1"># Create the builder</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">AuditorClientBuilder</span><span class="p">()</span>

<span class="c1"># Configure the Builder</span>
<span class="n">auditor_address</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">auditor_port</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">address</span><span class="p">(</span><span class="n">auditor_address</span><span class="p">,</span> <span class="n">auditor_port</span><span class="p">)</span>

<span class="c1"># Build the AuditorClient object</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="pushing-records-to-auditor">
<h2>Pushing records to Auditor<a class="headerlink" href="#pushing-records-to-auditor" title="Link to this heading"></a></h2>
<p>Assuming that a record and a client were already created, the record can be pushed to Auditor like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="pushing-a-list-of-records-to-auditor">
<h2>Pushing a list of records to Auditor<a class="headerlink" href="#pushing-a-list-of-records-to-auditor" title="Link to this heading"></a></h2>
<p>Assuming that a list of records and a client were already created, the record can be pushed to Auditor like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="updating-records-in-auditor">
<h2>Updating records in Auditor<a class="headerlink" href="#updating-records-in-auditor" title="Link to this heading"></a></h2>
<p>Auditor accepts incomplete records. In particular, the stop time can be missing. These records can be updated at a later time, by adding the same record which includes a stop time.
Note that the <code class="docutils literal notranslate"><span class="pre">record_id</span></code> must match the one already in the database!
Fields other than the stop time cannot be updated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_stop_time</span><span class="p">(</span><span class="n">stop_time</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="receiving-all-records-from-auditor-deprecated">
<h2>Receiving all records from Auditor (Deprecated)<a class="headerlink" href="#receiving-all-records-from-auditor-deprecated" title="Link to this heading"></a></h2>
<p>Via <code class="docutils literal notranslate"><span class="pre">get()</span></code> all records can be retrieved from Auditor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="receiving-all-records-started-stopped-since-a-given-timestamp-deprecated">
<h2>Receiving all records started/stopped since a given timestamp (Deprecated)<a class="headerlink" href="#receiving-all-records-started-stopped-since-a-given-timestamp-deprecated" title="Link to this heading"></a></h2>
<p>The records to be retrieved can be limited to the ones started or stopped since a given timestamp.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_records_started_since</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_started_since</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
<span class="n">list_of_records_stopped_since</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_stopped_since</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="advanced-query">
<h2>Advanced Query<a class="headerlink" href="#advanced-query" title="Link to this heading"></a></h2>
<p>Records can be queried using fields and operators.</p>
<section id="template-query">
<h3>Template Query<a class="headerlink" href="#template-query" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">GET</span> <span class="pre">/records?&lt;field&gt;[&lt;operator&gt;]=&lt;value&gt;</span>
<span class="pre">`</span></code></p>
<p>This is how the query is structured and multiple fields and values can be queried together as shown below.</p>
</section>
<section id="operators">
<h3>Operators<a class="headerlink" href="#operators" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><cite>gt</cite> (greater than)</p></li>
<li><p><cite>gte</cite> (greater than or equal to)</p></li>
<li><p><cite>lt</cite> (less than)</p></li>
<li><p><cite>lte</cite> (less than or equal to)</p></li>
<li><p><cite>equals</cite> (equal to)</p></li>
</ul>
</section>
<section id="meta-operators">
<h3>Meta Operators<a class="headerlink" href="#meta-operators" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><cite>c</cite> (contains)</p></li>
<li><p><cite>dnc</cite> (does not contain)</p></li>
</ul>
</section>
<section id="sortby-operators">
<h3>SortBy Operators<a class="headerlink" href="#sortby-operators" title="Link to this heading"></a></h3>
<blockquote>
<div><ul class="simple">
<li><p><cite>asc</cite> (ascending order)</p></li>
<li><p><cite>desc</cite> (descending order)</p></li>
</ul>
</div></blockquote>
</section>
<section id="sortby-column-names">
<h3>SortBy Column names<a class="headerlink" href="#sortby-column-names" title="Link to this heading"></a></h3>
<p>You can specify the column on which the sorting must happen
The following columns are supported for sortby option
- <cite>start_time</cite>
- <cite>stop_time</cite>
- <cite>runtime</cite>
- <cite>record_id</cite></p>
</section>
<section id="filter-fields-and-operators">
<h3>Filter Fields and Operators<a class="headerlink" href="#filter-fields-and-operators" title="Link to this heading"></a></h3>
<p>The table shows the fields and the corresponding operators available for each field with which a query can be built.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Operators</p></th>
<th class="head"><p>Examples (query representation)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>record_id</cite></p></td>
<td><p>Exact record to be retrieved using record_id</p></td>
<td></td>
<td><p>record_id=&lt;record_id&gt;</p></td>
</tr>
<tr class="row-odd"><td><p><cite>start_time</cite></p></td>
<td><p>Start time of the event (<cite>DateTime&lt;Utc&gt;</cite>)</p></td>
<td><p><cite>gt</cite>, <cite>gte</cite>, <cite>lt</cite>, <cite>lte</cite></p></td>
<td><p>start_time[gt]=&lt;timestamp&gt;</p></td>
</tr>
<tr class="row-even"><td><p><cite>stop_time</cite></p></td>
<td><p>Stop time of the event (<cite>DateTime&lt;Utc&gt;</cite>)</p></td>
<td><p><cite>gt</cite>, <cite>gte</cite>, <cite>lt</cite>, <cite>lte</cite></p></td>
<td><p>stop_time[gt]=&lt;timestamp&gt;</p></td>
</tr>
<tr class="row-odd"><td><p><cite>runtime</cite></p></td>
<td><p>Runtime of the event (in seconds)</p></td>
<td><p><cite>gt</cite>, <cite>gte</cite>, <cite>lt</cite>, <cite>lte</cite></p></td>
<td><p>runtime[gt]=&lt;int&gt;</p></td>
</tr>
<tr class="row-even"><td><p><cite>meta</cite></p></td>
<td><p>Meta information</p></td>
<td><p><cite>c</cite>, <cite>dnc</cite></p></td>
<td><p>meta[&lt;meta_key&gt;][c]=&lt;meta_value&gt;</p></td>
</tr>
<tr class="row-odd"><td><p><cite>component</cite></p></td>
<td><p>Component identifier</p></td>
<td><p><cite>gt</cite>, <cite>gte</cite>, <cite>lt</cite>, <cite>lte</cite>, <cite>equals</cite></p></td>
<td><p>component[&lt;component_name&gt;][gt]=&lt;amount&gt;</p></td>
</tr>
<tr class="row-even"><td><p><cite>sort_by</cite></p></td>
<td><p>Sort the records</p></td>
<td><p><cite>asc</cite>, <cite>desc</cite></p></td>
<td><p>sort_by[asc]=&lt;column_name&gt;</p></td>
</tr>
<tr class="row-odd"><td><p><cite>limit</cite></p></td>
<td><p>Limit the query results</p></td>
<td></td>
<td><p>limit=&lt;number&gt;</p></td>
</tr>
</tbody>
</table>
<p>Meta field can be used to query records by specifying the meta key and MetaOperator must be used
to specify meta values. The MetaOperator must be used to specify whether the value is
contained or is not contained for the specific Metakey.</p>
<p>Component field can be used to query records by specifying the component name (CPU) and [‘Operator’] must be used
to specify the amount.</p>
<p>To query records based on a range, specify the field with two operators
Either with gt or gte and lt or lte.</p>
<p>For example,
To query records with start_time ranging between two timestamps.</p>
<p><code class="docutils literal notranslate"><span class="pre">`text</span>
<span class="pre">Get</span> <span class="pre">records?start_time[gt]=timestamp1&amp;start_time[lt]=timestamp2</span>
<span class="pre">`</span></code></p>
</section>
</section>
<section id="querybuilder">
<h2>QueryBuilder<a class="headerlink" href="#querybuilder" title="Link to this heading"></a></h2>
<p>Below are the examples to query records using QueryBuilder methods. It helps to build query string which can be passed
as an argument to advanced_query function to get the records.</p>
<section id="examples-1">
<h3>Examples 1:<a class="headerlink" href="#examples-1" title="Link to this heading"></a></h3>
<p>Query all records</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueryBuilder</span>

<span class="n">query_string</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">advanced_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-2">
<h3>Example 2:<a class="headerlink" href="#example-2" title="Link to this heading"></a></h3>
<p>Query records with start_time greater than the timestamp</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">QueryBuilder</span>

<span class="c1"># Set the datetime value in Utc using Value object</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">Value</span><span class="o">.</span><span class="n">set_datetime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

<span class="c1"># Set the operator using Value object created in the previous step</span>
<span class="n">operator</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># Build the query string using build method from QueryBuilder object</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">with_start_time</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

<span class="c1"># Pass the query_string as an argument to advanced_query function</span>
<span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">advanced_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-3">
<h3>Example 3:<a class="headerlink" href="#example-3" title="Link to this heading"></a></h3>
<p>Query records with meta key = site_id and value = site1</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaOperator</span><span class="p">,</span> <span class="n">MetaQuery</span><span class="p">,</span> <span class="n">QueryBuilder</span>

<span class="n">meta_operator</span> <span class="o">=</span> <span class="n">MetaOperator</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;site1&quot;</span><span class="p">)</span>
<span class="n">meta_query</span> <span class="o">=</span> <span class="n">MetaQuery</span><span class="p">()</span><span class="o">.</span><span class="n">meta_operator</span><span class="p">(</span><span class="s2">&quot;site_id&quot;</span><span class="p">,</span> <span class="n">meta_operator</span><span class="p">)</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">with_meta_query</span><span class="p">(</span><span class="n">meta_query</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">advanced_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-4">
<h3>Example 4:<a class="headerlink" href="#example-4" title="Link to this heading"></a></h3>
<p>Query records with component name = CPU and amount = 10</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Operator</span><span class="p">,</span> <span class="n">ComponentQuery</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">QueryBuilder</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">Value</span><span class="o">.</span><span class="n">set_count</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">component_operator</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">()</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">component_query</span> <span class="o">=</span> <span class="n">ComponentQuery</span><span class="p">()</span><span class="o">.</span><span class="n">component_operator</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="n">component_operator</span><span class="p">)</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">with_component_query</span><span class="p">(</span><span class="n">component_query</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">advanced_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-5">
<h3>Example 5:<a class="headerlink" href="#example-5" title="Link to this heading"></a></h3>
<p>Query records sorted by stop_time in descending order and limit the query to 500 records</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">SortBy</span>

<span class="n">sort_by</span> <span class="o">=</span> <span class="n">SortBy</span><span class="p">()</span><span class="o">.</span><span class="n">descending</span><span class="p">(</span><span class="s2">&quot;stop_time&quot;</span><span class="p">)</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="n">sort_by</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">advanced_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>Example 5:<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>Query records by exact record_id</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pyauditor</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueryBuilder</span>

<span class="n">query_string</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">with_record_id</span><span class="p">(</span><span class="s2">&quot;record-1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">advanced_query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="checking-the-health-of-auditor">
<h2>Checking the health of Auditor<a class="headerlink" href="#checking-the-health-of-auditor" title="Link to this heading"></a></h2>
<p>The health of Auditor can be checked with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">healthy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
<span class="k">if</span> <span class="n">healthy</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:)&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:(&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="creating-utc-timestamps">
<h2>Creating UTC timestamps<a class="headerlink" href="#creating-utc-timestamps" title="Link to this heading"></a></h2>
<p>This section gives hints on how to create appropriate timestamps for use with Auditor.
The <cite>actual</cite> timezone assigned to the <cite>datetime</cite> object is irrelevant when passed to any pyauditor classes/functions/methods!
Only the actual numbers for hours, minutes, and so on matter.</p>
<section id="timestamp-already-in-utc">
<h3>Timestamp already in UTC<a class="headerlink" href="#timestamp-already-in-utc" title="Link to this heading"></a></h3>
<p>Even if the timestamps you are using are already in UTC, timezone information should be explicitly specified.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">79043</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="c1"># in UTC</span>
</pre></div>
</div>
</section>
<section id="timestamp-in-local-time">
<h3>Timestamp in local time<a class="headerlink" href="#timestamp-in-local-time" title="Link to this heading"></a></h3>
<p>This requires the python modules <code class="docutils literal notranslate"><span class="pre">tzlocal</span></code>.</p>
<p>Assuming that you are creating the timestamp yourself (it is not obtained from an external source), you need to attach the local timezone to the timestamp and then convert it to UTC:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tzlocal</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_localzone</span>
<span class="n">local_tz</span> <span class="o">=</span> <span class="n">get_localzone</span><span class="p">()</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">00</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">48942</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">local_tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</pre></div>
</div>
<p>If you have a <code class="docutils literal notranslate"><span class="pre">datetime</span></code> object from some external source, the timezone can be attached like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tzlocal</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_localzone</span>
<span class="n">local_tz</span> <span class="o">=</span> <span class="n">get_localzone</span><span class="p">()</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime_from_somewhere_else</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">local_tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</pre></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">datetime.now()</span></code> the local timezone also has to be provided explicitly. However, the parameter is now called <code class="docutils literal notranslate"><span class="pre">tz</span></code> instead of <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> because who needs consistency anyways?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tzlocal</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_localzone</span>
<span class="n">local_tz</span> <span class="o">=</span> <span class="n">get_localzone</span><span class="p">()</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">local_tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to pyauditor’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="API Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Auditor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>