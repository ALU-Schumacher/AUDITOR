<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; pyauditor  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Documentation" href="api.html" />
    <link rel="prev" title="Welcome to pyauditor’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pyauditor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-record">Creating a Record</a></li>
<li class="toctree-l2"><a class="reference internal" href="#connecting-to-auditor">Connecting to Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pushing-records-to-auditor">Pushing records to Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-records-in-auditor">Updating records in Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#receiving-all-records-from-auditor">Receiving all records from Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#receiving-all-records-started-stopped-since-a-given-timestamp">Receiving all records started/stopped since a given timestamp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checking-the-health-of-auditor">Checking the health of Auditor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-utc-timestamps">Creating UTC timestamps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#timestamp-already-in-utc">Timestamp already in UTC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#timestamp-in-local-time">Timestamp in local time</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pyauditor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/examples.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial">
<span id="ref-examples"></span><h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this heading"></a></h1>
<p>This section walks you through several basic usecases of <cite>pyauditor</cite>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Records and interacting with Auditor requires timestamps, for instance to indicate when a resource became available or unavailable, or when requesting a list of records from Auditor.
For simplicity, the entire Auditor ecosystem uses UTC.
Pythons handling of timezones is unfortunately suboptimal, therefore ensuring that the times are correct is your responsibility.
At the end of this section there is a short tutorial on how to get correct timestamps.</p>
</div>
<p>Auditor is designed around so-called records, which are the unit of accountable resources.
Records are created and pushed to Auditor, which stores them in a database.
These records can then be requested again from Auditor to take an action based on the information stored in the records.</p>
<p>A record consists of a unique identifier and meta information which provides some context (associated site, group, user).
It also contains an arbitrary number of <cite>components</cite> that are to be accounted for (CPU, RAM, Disk, …) and the amount of each of these components.
The components can optionally be enhanced with <cite>scores</cite>  which are are floating point values which put components of the same kind, but different performance in relation to each other.
For instance, in case of CPUs these could be HEPSPEC06 benchmark values.</p>
<p>pyauditor is an async library and as such requires an event loop.</p>
<section id="creating-a-record">
<h2>Creating a Record<a class="headerlink" href="#creating-a-record" title="Permalink to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyauditor</span> <span class="kn">import</span> <span class="n">Record</span><span class="p">,</span> <span class="n">Meta</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">Score</span>

<span class="c1"># Define meta information</span>
<span class="n">record_id</span> <span class="o">=</span> <span class="s2">&quot;record-1&quot;</span> <span class="c1"># Must be unique for all records in Auditor!</span>

<span class="c1"># Time when the resource became available</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">79043</span><span class="p">)</span> <span class="c1"># in UTC</span>

<span class="c1"># Create record</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">record_id</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

<span class="c1"># Create a component (10 CPU cores)</span>
<span class="n">component</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Create a score</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="s2">&quot;HEPSPEC06&quot;</span><span class="p">,</span> <span class="mf">9.2</span><span class="p">)</span>

<span class="c1"># Attach the score to the component</span>
<span class="n">component</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">with_score</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

<span class="c1"># Attach the component to the record</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

<span class="c1"># Create meta</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">()</span>

<span class="c1"># Add information to meta</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;site_id&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;site1&quot;</span><span class="p">])</span>

<span class="c1"># Attach meta to record</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

<span class="c1"># Resource stopped being available</span>
<span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">79043</span><span class="p">)</span> <span class="c1"># in UTC</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_stop_time</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="connecting-to-auditor">
<h2>Connecting to Auditor<a class="headerlink" href="#connecting-to-auditor" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">AuditorClientBuilder</span></code> is used to build an <code class="docutils literal notranslate"><span class="pre">AuditorClient</span></code> object which can be used for interacting with Auditor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyauditor</span> <span class="kn">import</span> <span class="n">AuditorClientBuilder</span>

<span class="c1"># Create the builder</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">AuditorClientBuilder</span><span class="p">()</span>

<span class="c1"># Configure the Builder</span>
<span class="n">auditor_address</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">auditor_port</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">address</span><span class="p">(</span><span class="n">auditor_address</span><span class="p">,</span> <span class="n">auditor_port</span><span class="p">)</span>

<span class="c1"># Build the AuditorClient object</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="pushing-records-to-auditor">
<h2>Pushing records to Auditor<a class="headerlink" href="#pushing-records-to-auditor" title="Permalink to this heading"></a></h2>
<p>Assuming that a record and a client were already created, the record can be pushed to Auditor like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="updating-records-in-auditor">
<h2>Updating records in Auditor<a class="headerlink" href="#updating-records-in-auditor" title="Permalink to this heading"></a></h2>
<p>Auditor accepts incomplete records. In particular, the stop time can be missing. These records can be updated at a later time, by adding the same record which includes a stop time.
Note that the <code class="docutils literal notranslate"><span class="pre">record_id</span></code> must match the one already in the database!
Fields other than the stop time cannot be updated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_stop_time</span><span class="p">(</span><span class="n">stop_time</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="receiving-all-records-from-auditor">
<h2>Receiving all records from Auditor<a class="headerlink" href="#receiving-all-records-from-auditor" title="Permalink to this heading"></a></h2>
<p>Via <code class="docutils literal notranslate"><span class="pre">get()</span></code> all records can be retrieved from Auditor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_records</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="receiving-all-records-started-stopped-since-a-given-timestamp">
<h2>Receiving all records started/stopped since a given timestamp<a class="headerlink" href="#receiving-all-records-started-stopped-since-a-given-timestamp" title="Permalink to this heading"></a></h2>
<p>The records to be retrieved can be limited to the ones started or stopped since a given timestamp.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_records_started_since</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_started_since</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
<span class="n">list_of_records_stopped_since</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_stopped_since</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="checking-the-health-of-auditor">
<h2>Checking the health of Auditor<a class="headerlink" href="#checking-the-health-of-auditor" title="Permalink to this heading"></a></h2>
<p>Assuming that a record and a client were already created, the record can be pushed to Auditor like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">healthy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">health_check</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<span class="k">if</span> <span class="n">healthy</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:)&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:(&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="creating-utc-timestamps">
<h2>Creating UTC timestamps<a class="headerlink" href="#creating-utc-timestamps" title="Permalink to this heading"></a></h2>
<p>This section gives hints on how to create appropriate timestamps for use with Auditor.
The <cite>actual</cite> timezone assigned to the <cite>datetime</cite> object is irrelevant when passed to any pyauditor classes/functions/methods!
Only the actual numbers for hours, minutes, and so on matter.</p>
<section id="timestamp-already-in-utc">
<h3>Timestamp already in UTC<a class="headerlink" href="#timestamp-already-in-utc" title="Permalink to this heading"></a></h3>
<p>When the timestamps you are using are already in UTC, they can be used without further processing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">00</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">48942</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="timestamp-in-local-time">
<h3>Timestamp in local time<a class="headerlink" href="#timestamp-in-local-time" title="Permalink to this heading"></a></h3>
<p>This requires the python modules <code class="docutils literal notranslate"><span class="pre">pytz</span></code> and <code class="docutils literal notranslate"><span class="pre">tzlocal</span></code>.</p>
<p>Assuming that you are creating the timestamp yourself (it is not obtained from an external source), you need to attach the local timezone to the timestamp and then convert it to UTC:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">tzlocal</span> <span class="kn">import</span> <span class="n">get_localzone</span>
<span class="n">local_tz</span> <span class="o">=</span> <span class="n">get_localzone</span><span class="p">()</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">00</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">48942</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">local_tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</pre></div>
</div>
<p>If you have a <code class="docutils literal notranslate"><span class="pre">datetime</span></code> object from some external source, the timezone can be attached like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">tzlocal</span> <span class="kn">import</span> <span class="n">get_localzone</span>
<span class="n">local_tz</span> <span class="o">=</span> <span class="n">get_localzone</span><span class="p">()</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime_from_somewhere_else</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">local_tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</pre></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">datetime.now()</span></code> the local timezone also has to be provided explicitly. However, the parameter is now called <code class="docutils literal notranslate"><span class="pre">tz</span></code> instead of <code class="docutils literal notranslate"><span class="pre">tzinfo</span></code> because who needs consistency anyways?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">tzlocal</span> <span class="kn">import</span> <span class="n">get_localzone</span>
<span class="n">local_tz</span> <span class="o">=</span> <span class="n">get_localzone</span><span class="p">()</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">local_tz</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to pyauditor’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="API Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Stefan Kroboth.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>