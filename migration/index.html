<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Migration | Auditor </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <style>
    :root {
        /* Primary theme color */
        /* --primary-color: #FED43F; */
        --primary-color: #344A9A;
        /* Primary theme text color */
        --primary-text-color: #000000;
        /* Primary theme link color */
        --primary-link-color: #F9BB2D;
        /* Secondary color: the background body color */
        --secondary-color: #fcfaf6;
        --secondary-text-color: #303030;
        /* Highlight text color of table of content */
        --toc-highlight-text-color: #d46e13;
    }
</style>

    <link href="https://fonts.googleapis.com/css?family=Alfa+Slab+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,500,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/normalize.css">
    <link rel="stylesheet" href="https://alu-schumacher.github.io/AUDITOR/juice.css">
    
    
</head>

<body>
    
<header class="box-shadow">
    

<a href="https:&#x2F;&#x2F;alu-schumacher.github.io&#x2F;AUDITOR&#x2F;">
    <div class="logo">
        <img src="https://alu-schumacher.github.io/AUDITOR/white_transparent_background.png" alt="logo">
         UDITOR
    </div>
</a>

<nav>
    
    <a class="nav-item header-text" href="https:&#x2F;&#x2F;alu-schumacher.github.io&#x2F;AUDITOR&#x2F;about&#x2F;">About</a>
    
    <a class="nav-item header-text" href="https:&#x2F;&#x2F;alu-schumacher.github.io&#x2F;AUDITOR&#x2F;changelog&#x2F;">ChangeLog</a>
    
    <a class="nav-item header-text" href="https:&#x2F;&#x2F;alu-schumacher.github.io&#x2F;AUDITOR&#x2F;development&#x2F;">Development</a>
    
    <a class="nav-item header-text" href="https:&#x2F;&#x2F;alu-schumacher.github.io&#x2F;AUDITOR&#x2F;migration&#x2F;">Migration</a>
    
    
        
        <a class="nav-item header-text" href="https:&#x2F;&#x2F;github.com&#x2F;ALU-Schumacher&#x2F;AUDITOR">Github</a>
        
    
</nav>

</header>


    <main>
        
        
        
        
        
        <div class="toc">
            <div class="toc-sticky">
                
                <div class="toc-item">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#from-0-2-0-to-unreleased">From 0.2.0 to unreleased</a>
                </div>
                
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#slurm-collector"><small>- Slurm collector</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#priority-plugin"><small>- Priority plugin</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#auditor"><small>- AUDITOR</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#development"><small>- Development</small></a>
                </div>
                
                
                
                <div class="toc-item">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#from-0-1-0-to-0-2-0">From 0.1.0 to 0.2.0</a>
                </div>
                
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#apel-plugin"><small>- Apel plugin</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#auditor-client"><small>- Auditor client</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#auditor-server"><small>- Auditor server</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#docker-containers"><small>- Docker containers</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#htcondor-plugin"><small>- HTCondor plugin</small></a>
                </div>
                
                <div class="toc-item-child">
                    <a class="subtext" href="https://alu-schumacher.github.io/AUDITOR/migration/#development-1"><small>- Development</small></a>
                </div>
                
                
                
            </div>
        </div>
        
        

        <div class="content text">
            
<div class="heading-text">Migration Guide</div>
<h1 id="from-0-2-0-to-unreleased">From 0.2.0 to unreleased</h1>
<h2 id="slurm-collector">Slurm collector</h2>
<p>New filter options for querying slurm jobs are available.
Due to this, a new section <code>job_filter</code> has been introduced for the config file.
The <code>job_status</code> field has been renamed to <code>status</code> and is now part of the <code>job_filter</code> section.</p>
<p>Before:</p>
<pre data-lang="yaml" style="background-color:#ffffff;color:#000000;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#00a33f;">job_status</span><span>:
</span><span>  - </span><span style="color:#00a33f;">&quot;completed&quot;
</span><span>  - </span><span style="color:#00a33f;">&quot;failed&quot;
</span></code></pre>
<p>After:</p>
<pre data-lang="yaml" style="background-color:#ffffff;color:#000000;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#00a33f;">job_filter</span><span>:
</span><span>  </span><span style="color:#00a33f;">status</span><span>:
</span><span>    - </span><span style="color:#00a33f;">&quot;completed&quot;
</span><span>    - </span><span style="color:#00a33f;">&quot;failed&quot;
</span></code></pre>
<p>The new filter options are <code>partition</code>, <code>user</code>, <code>group</code>, and <code>account</code> and work similar to the <code>status</code> filter.</p>
<h2 id="priority-plugin">Priority plugin</h2>
<p>The priority plugin now supports exporting metrics for the amount of provided resources and the updated priority to Prometheus.
The metrics can be accessed via a GET request to the <code>/metrics</code> endpoint.
Because the metrics endpoint provided by the Prometheus exporter needs to be available all the time, the architecture of the
priority plugin has been changed. It now will run continuously. In most cases, it should be started as a systemd service.</p>
<p>The structure of the config file has changed. The <code>addr</code> and <code>port</code> options are now put under a common <code>auditor</code> section.
The frequency of recalculation for the provided resources and priorities can now be controlled with the <code>frequency</code> field, which assumes that the number given is in seconds.
It defaults to 1 hour (i.e. 3600s).</p>
<p>The Prometheus exporter can be configured in the <code>prometheus</code> section.
It can be enabled and disabled with the <code>enable</code> field.
The address and port of the HTTP server that serves the metrics can be set with the <code>addr</code> and <code>port</code> fields.
The <code>metrics</code> list specifies the metrics that are exported. Right now the values <code>ResourceUsage</code> (for the amount of provided resources in the given duration)
and <code>Priority</code> (for the calculated priority value) are supported.
The <code>prometheus</code> section is optional. If it is not present, it has the same effect as setting <code>enable</code> to <code>false</code>.</p>
<p>Below, you find an example of the priority plugin configuration before and after the change.</p>
<ul>
<li>
<p>Before </p>
<pre data-lang="yaml" style="background-color:#ffffff;color:#000000;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#00a33f;">addr</span><span>: </span><span style="color:#00a33f;">&quot;localhost&quot;
</span><span style="color:#00a33f;">port</span><span>: 8000
</span><span>... </span><span style="color:#00a33f;">(other options)
</span></code></pre>
</li>
<li>
<p>After</p>
<pre data-lang="yaml" style="background-color:#ffffff;color:#000000;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#00a33f;">auditor</span><span>:
</span><span>  </span><span style="color:#00a33f;">addr</span><span>: </span><span style="color:#00a33f;">&quot;localhost&quot;
</span><span>  </span><span style="color:#00a33f;">port</span><span>: 8000
</span><span style="color:#00a33f;">frequency</span><span>: 3600
</span><span>... </span><span style="color:#00a33f;">(other options)
</span><span style="color:#00a33f;">prometheus</span><span>:
</span><span>  </span><span style="color:#00a33f;">enable</span><span>: </span><span style="color:#a535ae;">true
</span><span>  </span><span style="color:#00a33f;">addr</span><span>: </span><span style="color:#00a33f;">&quot;0.0.0.0&quot;
</span><span>  </span><span style="color:#00a33f;">port</span><span>: 9000
</span><span>  </span><span style="color:#00a33f;">metrics</span><span>:
</span><span>    - </span><span style="color:#00a33f;">ResourceUsage
</span><span>    - </span><span style="color:#00a33f;">Priority
</span></code></pre>
</li>
</ul>
<h2 id="auditor">AUDITOR</h2>
<h3 id="standardized-rest-apis">Standardized REST APIs</h3>
<p>Auditor REST APIs are changed as shown in the table below. </p>
<table><thead><tr><th>Action</th><th>Before</th><th>After</th></tr></thead><tbody>
<tr><td>Health check</td><td><code>/health_check</code> (GET)</td><td><code>/health_check</code> (GET)</td></tr>
<tr><td>Add record</td><td><code>/add</code> (POST)</td><td><code>/record</code> (POST)</td></tr>
<tr><td>Update record</td><td><code>/update</code> (POST)</td><td><code>/record</code> (PUT)</td></tr>
<tr><td>Get all records</td><td><code>/get</code> (GET)</td><td><code>/record</code> (GET)</td></tr>
<tr><td>Get records since</td><td><code>/get/[started/stopped]/since/{date}</code> (GET)</td><td><code>/record?state=[started/stopped]&amp;since={date}</code> (GET)</td></tr>
</tbody></table>
<h2 id="development">Development</h2>
<h3 id="update-to-sqlx-0-7-2">Update to <a href="https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md">sqlx 0.7.2</a></h3>
<p>Use this command to update the sqlx-cli to 0.7.2</p>
<ul>
<li><code>cargo install --version=0.7.2 sqlx-cli --no-default-features --features postgres,rustls,sqlite</code></li>
</ul>
<h1 id="from-0-1-0-to-0-2-0">From 0.1.0 to 0.2.0</h1>
<h2 id="apel-plugin">Apel plugin</h2>
<ul>
<li>The config file now needs to have a field <code>cpu_time_unit</code> present, which describes the unit of total CPU time in the AUDITOR records.
Possible values are <code>seconds</code> or <code>milliseconds</code>.</li>
<li>Support for Python 3.6 and Python 3.7 has been dropped. Please move to a newer version of python.</li>
</ul>
<h2 id="auditor-client">Auditor client</h2>
<ul>
<li>Support for Python 3.6 and Python 3.7 has been dropped. Please move to a newer version of python.</li>
<li>Due to the update of the <code>pyo3</code> library, the timezone of datetime objects now needs to be <code>datetime.timezone.utc</code> instead of <code>pytz.utc</code>
when creating a new record:
<ul>
<li>When the datetime object is already in UTC
<ul>
<li>Before<pre data-lang="python" style="background-color:#ffffff;color:#000000;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ff5600;">import </span><span>datetime
</span><span style="color:#ff5600;">import </span><span>pytz
</span><span>
</span><span>start_since </span><span style="color:#ff5600;">= </span><span>datetime.datetime(2022, 8, 8, 11, 30, 0, 0, tzinfo</span><span style="color:#ff5600;">=</span><span>pytz.utc)
</span></code></pre>
</li>
<li>After<pre data-lang="python" style="background-color:#ffffff;color:#000000;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ff5600;">import </span><span>datetime
</span><span>
</span><span>start_since </span><span style="color:#ff5600;">= </span><span>datetime.datetime(2022, 8, 8, 11, 30, 0, 0, tzinfo</span><span style="color:#ff5600;">=</span><span>datetime.timezone.utc)
</span></code></pre>
</li>
</ul>
</li>
<li>If it is in local time
<ul>
<li>Before<pre data-lang="python" style="background-color:#ffffff;color:#000000;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ff5600;">import </span><span>datetime
</span><span style="color:#ff5600;">import </span><span>pytz
</span><span style="color:#ff5600;">from </span><span>tzlocal </span><span style="color:#ff5600;">import </span><span>get_localzone
</span><span>
</span><span>local_tz </span><span style="color:#ff5600;">= </span><span>get_localzone()
</span><span>start_since </span><span style="color:#ff5600;">= </span><span>datetime.datetime(2022, 8, 8, 11, 30, 0, 0, tzinfo</span><span style="color:#ff5600;">=</span><span>local_tz).astimezone(pytz.utc)
</span></code></pre>
</li>
<li>After<pre data-lang="python" style="background-color:#ffffff;color:#000000;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#ff5600;">import </span><span>datetime
</span><span style="color:#ff5600;">from </span><span>tzlocal </span><span style="color:#ff5600;">import </span><span>get_localzone
</span><span>
</span><span>local_tz </span><span style="color:#ff5600;">= </span><span>get_localzone()
</span><span>start_since </span><span style="color:#ff5600;">= </span><span>datetime.datetime(2022, 8, 8, 11, 30, 0, 0, tzinfo</span><span style="color:#ff5600;">=</span><span>local_tz).astimezone(datetime.timezone.utc)
</span></code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="auditor-server">Auditor server</h2>
<ul>
<li>Updating a non-existent record now returns an HTTP 404 error instead of HTTP 400 error</li>
</ul>
<h2 id="docker-containers">Docker containers</h2>
<ul>
<li>The <code>main</code> tag was replaced with the <code>edge</code> tag. In addition, we also now offer docker tags corresponding to releases, i.e., use the tag <code>0.2.0</code> for this release.</li>
</ul>
<h2 id="htcondor-plugin">HTCondor plugin</h2>
<ul>
<li>Support for Python 3.6 and Python 3.7 has been dropped. Please move to a newer version of python.</li>
</ul>
<h2 id="development-1">Development</h2>
<h3 id="update-to-sqlx-0-7-1">Update to <a href="https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md">sqlx 0.7.1</a></h3>
<p>Use this command to update the sqlx-cli to 0.7.1</p>
<ul>
<li><code>cargo install --version=0.7.1 sqlx-cli --no-default-features --features postgres,rustls,sqlite</code></li>
</ul>


        </div>

        
        
    </main>

    
    <footer>
        <small class="subtext">
            <a href="https://huhu.io">Huhu.io</a> © 2021
        </small>
    </footer>
    
</body>
<script>
    function highlightNav(heading) {
        let pathname = location.pathname;
        document.querySelectorAll(".toc a").forEach((item) => {
            item.classList.remove("active");
        });
        document.querySelector(".toc a[href$='" + pathname + "#" + heading + "']").classList.add("active");
    }

    let currentHeading = "";
    window.onscroll = function () {
        let h = document.querySelectorAll("h1,h2,h3,h4,h5,h6");
        let elementArr = [];

        h.forEach(item => {
            if (item.id !== "") {
                elementArr[item.id] = item.getBoundingClientRect().top;
            }
        });
        elementArr.sort();
        for (let key in elementArr) {
            if (!elementArr.hasOwnProperty(key)) {
                continue;
            }
            if (elementArr[key] > 0 && elementArr[key] < 300) {
                if (currentHeading !== key) {
                    highlightNav(key);
                    currentHeading = key;
                }
                break;
            }
        }
    }
</script>

</html>
